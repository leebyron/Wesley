{"ts":1349519905463,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// TODO: better tokenizing of \"phrases\"\n\nvar CraigRequest = require('./CraigRequest.js');\nvar Geo = require('./Geo.js');\n\nvar ID_RX         = /\\d{8,14}/;\nvar INLINE_TAG_RX = /<\\/?(i|b|u|strong|td|span)[^>]*?>/ig;\nvar TAG_RX        = /<[^>]+?>/g;\nvar SPACE_RX      = /[\\s]{2,}/g;\nvar NO_RX         = /\\b(n|no|non)\\b/i;\nvar ALL_CAPS_RX   = /[^a-z\\n\\.]{6,}/g;\nvar CAP_RX        = /^[A-Z]/;\nvar NUM_RX        = /\\d+|one|two|three|four|five|six|seven|eight|nine/;\nvar CLTAG_RX      = /<!-- CLTAG ([a-z0-9]+)=(.+?) -->/g;\n\nvar PHONE_RX      = /1?[\\.\\-\\(\\s]?\\d{3}?[\\.\\-\\)\\s]?\\d{3}[\\.\\-\\s]?\\d{4}/;\nvar PHONE_JUNK_RX = /[^\\d]/g;\nvar EMAIL_RX      = /Reply to: <a href=\"mailto:([A-Za-z0-9\\-\\.@]+)/;\nvar IMAGE_RX      = /<img.+?src=\"([^\"]+)\"/g;\n\nvar PRICE_RX      = /\\$([0-9]{3,6})/;\nvar SQFT_RX       = /(\\d{3,4})\\+?\\s?(ft2|ftÂ²|sqft|sq\\.? foot)/;\nvar SQFT2_RX      = /sq\\.? footage:?\\s*(\\d{3,4})/i;\nvar BEDROOMS_RX   = /([\\d\\.]+|no|one|two|three|four|five|six|seven|eight|nine)\\s?(br|bd|bed|bedroom)s?\\b/i;\nvar BEDROOMS2_RX  = /bed(room)?s?:?\\s*(\\d+)/i;\nvar BATHROOMS_RX  = /([\\d\\.]+|no|one|two|three|four|five|six|seven|eight|nine)\\s?(ba|bath|bathroom)s?\\b/i;\nvar BATHROOMS2_RX = /bath(room)?s?:?\\s*(\\d+)/i;\nvar DOGS_RX       = /[^\\n\\.]*\\b(dog|pet)s?(\\spolicy)?\\b(:\\s+)?[^\\n\\.]*/i;\nvar PARKING_RX    = /(^|\\.|\\*|\\n)([^\\.\\*\\n]*?\\b(parking|garage)\\b[^\\.\\*\\n]*?)($|\\.|\\*|\\n)/i;\n\nvar BLACKLIST_RX  = /\\b(scam|fraud|fake|sanfranciscobayrentals)\\b/i;\n\nfunction CraigListing() {\n  this.title = undefined;\n  this.id = undefined;\n  this.url = undefined;\n  this.listed = undefined;\n  this.email = undefined;\n  this.phone = undefined;\n  this.address = undefined;\n  this.addressDetail = {};\n  this.price = undefined;\n  this.sqft = undefined;\n  this.bedrooms = undefined;\n  this.bathrooms = undefined;\n  this.dogs = undefined;\n  this.parking = undefined;\n  this.images = [];\n  this.description = undefined;\n}\n\nmodule.exports = CraigListing;\n\nCraigListing.fromRSS = function (item) {\n  var link = item.get('xmlns:link', 'http://purl.org/rss/1.0/').text();\n  var title = item.get('xmlns:title', 'http://purl.org/rss/1.0/').text();\n  var date = item.get('dc:date', {'dc':'http://purl.org/dc/elements/1.1/'}).text();\n  var htmlDescription = item.get('xmlns:description', 'http://purl.org/rss/1.0/').text();\n\n  if (BLACKLIST_RX.test(title) || BLACKLIST_RX.test(htmlDescription)) {\n    return null;\n  }\n\n  var listing = new CraigListing();\n  listing.url = link;\n  listing.id = ID_RX.exec(link)[0];\n  listing.title = sanitizeText(title);\n  listing.listed = new Date(date);\n  listing.description = tokenizeHTML(htmlDescription);\n\n  derivePhone(listing);\n  derivePrice(listing);\n  deriveSqft(listing);\n  deriveDogs(listing);\n  deriveBedrooms(listing);\n  deriveBathrooms(listing);\n  deriveParking(listing);\n  deriveAddress(listing, htmlDescription);\n\n  var clTagStart = htmlDescription.indexOf('<!-- START CLTAGS -->');\n  if (clTagStart !== -1) {\n    listing.description = sanitizeText(tokenizeHTML(htmlDescription.substr(0,clTagStart)));\n  } else {\n    listing.description = sanitizeText(listing.description);\n  }\n\n  return listing;\n};\n\nCraigListing.prototype.loadAdditionalInformation = function (callback) {\n  CraigRequest.get(this.url, function (error, data) {\n    if (!data) {\n      callback(error);\n      return;\n    }\n\n    deriveEmail(this, data);\n    deriveImages(this, data);\n\n    if (this.address) {\n      // geocode\n      Geo.geocode(this.address, function (error, place) {\n        if (!error) {\n          this.addressDetail.address = place.address;\n          this.addressDetail.accuracy = place.AddressDetails.Accuracy;\n          this.addressDetail.coordinate = place.Point.coordinates;\n          this.addressDetail.region = place.ExtendedData.LatLonBox;\n        }\n        callback(error);\n      }.bind(this));\n    } else {\n      callback(null);\n    }\n\n    // WALKSCORE, IMAGES, TRANSIT\n\n  }.bind(this));\n};\n\n\nfunction tokenizeHTML(html) {\n  html = html.replace(INLINE_TAG_RX, ' ');\n  return html.replace(TAG_RX, '\\n');\n}\n\nfunction getCLTags(html) {\n  var tags = {};\n  var result;\n  while (result = CLTAG_RX.exec(html)) {\n    tags[result[1]] = result[2];\n  }\n  return tags;\n}\n\nvar NUMBER_MAP = {\n  'no'    : 0,\n  'one'   : 1,\n  'two'   : 2,\n  'three' : 3,\n  'four'  : 4,\n  'five'  : 5,\n  'six'   : 6,\n  'seven' : 7,\n  'eight' : 8,\n  'nine'  : 9\n};\n\nfunction sanitizeNumber(numberish) {\n  var num;\n\n  // replace 1+1 with 1.5\n  numberish = numberish.replace('+1', '.5');\n\n  num = parseFloat(numberish);\n  if (!isNaN(num)) {\n    return num;\n  }\n\n  num = NUMBER_MAP[numberish];\n  if (num != null) {\n    return num;\n  }\n\n  return numberish;\n}\n\nfunction sanitizeText(text) {\n  text = text.trim();\n\n  if (ALL_CAPS_RX.test(text)) {\n    text = text.replace(ALL_CAPS_RX, _fixAllCaps);\n  }\n\n  text = text.replace(SPACE_RX, ' ');\n\n  return text;\n}\n\nfunction _fixAllCaps(text) {\n  if (CAP_RX.test(text)) {\n    return text.substr(0, 1) + text.substr(1).toLowerCase();\n  } else {\n    return text.toLowerCase();\n  }\n}\n\nfunction derivePhone(listing) {\n  if (PHONE_RX.test(listing.description)) {\n    listing.phone = PHONE_RX.exec(listing.description)[0].replace(PHONE_JUNK_RX, '');\n  }\n}\n\nfunction derivePrice(listing) {\n  if (PRICE_RX.test(listing.title)) {\n    listing.price = sanitizeNumber(PRICE_RX.exec(listing.title)[1]);\n  } else if (PRICE_RX.test(listing.description)) {\n    listing.price = sanitizeNumber(PRICE_RX.exec(listing.description)[1]);\n  }\n}\n\nfunction deriveSqft(listing) {\n  if (SQFT_RX.test(listing.title)) {\n    listing.sqft = sanitizeNumber(SQFT_RX.exec(listing.title)[1]);\n  } else if (SQFT_RX.test(listing.description)) {\n    listing.sqft = sanitizeNumber(SQFT_RX.exec(listing.description)[1]);\n  } else if (SQFT2_RX.test(listing.description)) {\n    listing.sqft = sanitizeNumber(SQFT2_RX.exec(listing.description)[1]);\n  }\n}\n\nfunction deriveBedrooms(listing) {\n  if (BEDROOMS_RX.test(listing.title)) {\n    listing.bedrooms = sanitizeNumber(BEDROOMS_RX.exec(listing.title)[1]);\n  } else if (BEDROOMS_RX.test(listing.description)) {\n    listing.bedrooms = sanitizeNumber(BEDROOMS_RX.exec(listing.description)[1]);\n  } else if (BEDROOMS2_RX.test(listing.description)) {\n    listing.bedrooms = sanitizeNumber(BEDROOMS2_RX.exec(listing.description)[2]);\n  }\n}\n\nfunction deriveBathrooms(listing) {\n  if (BATHROOMS_RX.test(listing.title)) {\n    listing.bathrooms = sanitizeNumber(BATHROOMS_RX.exec(listing.title)[1]);\n  } else if (BATHROOMS_RX.test(listing.description)) {\n    listing.bathrooms = sanitizeNumber(BATHROOMS_RX.exec(listing.description)[1]);\n  } else if (BATHROOMS2_RX.test(listing.description)) {\n    listing.bathrooms = sanitizeNumber(BATHROOMS2_RX.exec(listing.description)[2]);\n  }\n}\n\nfunction deriveDogs(listing) {\n  if (listing.description.indexOf('dogs are OK') !== -1) {\n    listing.dogs = true;\n  } else if (DOGS_RX.test(listing.description)) {\n    var dog_phrase = DOGS_RX.exec(listing.description)[0];\n    if (NO_RX.test(dog_phrase)) {\n      listing.dogs = false;\n    } else {\n      listing.dogs = sanitizeText(dog_phrase);\n    }\n  }\n}\n\nfunction deriveParking(listing) {\n  var parking_phrase = null;\n  if (PARKING_RX.test(listing.description)) {\n    parking_phrase = PARKING_RX.exec(listing.description)[2];\n  } else if (PARKING_RX.test(listing.title)) {\n    parking_phrase = PARKING_RX.exec(listing.title)[2];\n  }\n  if (parking_phrase) {\n    if (NO_RX.test(parking_phrase)) {\n      listing.parking = false;\n    } else {\n      listing.parking = sanitizeText(parking_phrase);\n    }\n  }\n}\n\nfunction deriveEmail(listing, data) {\n  if (EMAIL_RX.test(data)) {\n    listing.email = EMAIL_RX.exec(data)[1];\n  }\n}\n\nfunction deriveImages(listing, data) {\n  var match, image;\n  while (match = IMAGE_RX.exec(data)) {\n    image = match[1];\n    if (image.indexOf('craigslistadtracker') === -1) {\n      listing.images.push(image);\n    }\n  }\n}\n\nfunction deriveAddress(listing, data) {\n  var tags = getCLTags(data);\n  var city = tags['city'] || 'San Francisco';\n  var region = tags['region'] || 'CA';\n  if (tags['xstreet0']) {\n    if (tags['xstreet1'] && !NUM_RX.test(tags['xstreet0'])) {\n      listing.address = tags['xstreet0'] + ' and ' + tags['xstreet1'] + ' ' + city + ' ' + region;\n    } else {\n      // TODO: find apt number\n      listing.address = tags['xstreet0'] + ' ' + city + ' ' + region;\n      if (tags['xstreet1']) {\n        listing.addressDetail.cross = tags['xstreet1'];\n      }\n    }\n  }\n}\n"]],"start1":0,"start2":0,"length1":0,"length2":8397}]],"length":8397}
{"contributors":[],"silentsave":false,"ts":1349519935806,"patch":[[{"diffs":[[0," (num !="],[1,"="],[0," null) {"]],"start1":4558,"start2":4558,"length1":16,"length2":17}]],"length":8398,"saved":false}
{"ts":1349520089989,"patch":[[{"diffs":[[0,"back) {\n"],[1,"  var listing = this;\n"],[0,"  CraigR"]],"start1":3171,"start2":3171,"length1":16,"length2":38},{"diffs":[[0,"est.get("],[-1,"this"],[1,"listing"],[0,".url, fu"]],"start1":3212,"start2":3212,"length1":20,"length2":23},{"diffs":[[0,"veEmail("],[-1,"this"],[1,"listing"],[0,", data);"]],"start1":3327,"start2":3327,"length1":20,"length2":23},{"diffs":[[0,"eImages("],[-1,"this"],[1,"listing"],[0,", data);"]],"start1":3360,"start2":3360,"length1":20,"length2":23},{"diffs":[[0,"    if ("],[-1,"this"],[1,"listing"],[0,".address"]],"start1":3385,"start2":3385,"length1":20,"length2":23},{"diffs":[[0,"geocode("],[-1,"this"],[1,"listing"],[0,".address"]],"start1":3439,"start2":3439,"length1":20,"length2":23},{"diffs":[[0,"or) {\n          "],[-1,"this"],[1,"listing"],[0,".addressDetail.a"]],"start1":3506,"start2":3506,"length1":36,"length2":39},{"diffs":[[0,"ress;\n          "],[-1,"this"],[1,"listing"],[0,".addressDetail.a"]],"start1":3563,"start2":3563,"length1":36,"length2":39},{"diffs":[[0,"racy;\n          "],[-1,"this"],[1,"listing"],[0,".addressDetail.c"]],"start1":3637,"start2":3637,"length1":36,"length2":39},{"diffs":[[0,"        "],[-1,"this"],[1,"listing"],[0,".address"]],"start1":3715,"start2":3715,"length1":20,"length2":23},{"diffs":[[0,"\n      }"],[-1,".bind(this)"],[0,""],[1,""],[0,");\n    }"]],"start1":3818,"start2":3818,"length1":27,"length2":16},{"diffs":[[0,"\n  }"],[-1,".bind(this)"],[0,""],[1,""],[0,");\n}"]],"start1":3905,"start2":3905,"length1":19,"length2":8},{"diffs":[[0,"  while "],[1,"("],[0,"(result "]],"start1":4088,"start2":4088,"length1":16,"length2":17},{"diffs":[[0,"c(html))"],[1,")"],[0," {\n    t"]],"start1":4119,"start2":4119,"length1":16,"length2":17}]],"length":8427,"saved":false}
{"contributors":[],"silentsave":false,"ts":1349520384996,"patch":[[{"diffs":[[0,"  while "],[1,"("],[0,"(match ="]],"start1":7701,"start2":7701,"length1":16,"length2":17},{"diffs":[[0,".exec(data))"],[1,")"],[0," {\n    image"]],"start1":7727,"start2":7727,"length1":24,"length2":25}]],"length":8429,"saved":false}
{"ts":1349520438134,"patch":[[{"diffs":[[0,"tags"],[-1,"['"],[1,"."],[0,"city"],[-1,"']"],[0," || "]],"start1":7950,"start2":7950,"length1":16,"length2":13},{"diffs":[[0,"tags"],[-1,"['"],[1,"."],[0,"region"],[-1,"']"],[0," || "]],"start1":7995,"start2":7995,"length1":18,"length2":15},{"diffs":[[0,"if (tags"],[-1,"['"],[1,"."],[0,"xstreet0"],[-1,"']"],[0,") {\n    "]],"start1":8018,"start2":8018,"length1":28,"length2":25},{"diffs":[[0,"if (tags"],[-1,"['"],[1,"."],[0,"xstreet1"],[-1,"']"],[0," && !NUM"]],"start1":8043,"start2":8043,"length1":28,"length2":25},{"diffs":[[0,"est(tags"],[-1,"['"],[1,"."],[0,"xstreet0"],[-1,"']"],[0,")) {\n   "]],"start1":8073,"start2":8073,"length1":28,"length2":25},{"diffs":[[0,"dress = tags"],[-1,"['"],[1,"."],[0,"xstreet0"],[-1,"']"],[0," + ' and ' +"]],"start1":8111,"start2":8111,"length1":36,"length2":33},{"diffs":[[0,"' + tags"],[-1,"['"],[1,"."],[0,"xstreet1"],[-1,"']"],[0," + ' ' +"]],"start1":8141,"start2":8141,"length1":28,"length2":25},{"diffs":[[0,"tags"],[-1,"['"],[1,"."],[0,"xstreet0"],[-1,"']"],[0," + '"]],"start1":8256,"start2":8256,"length1":20,"length2":17},{"diffs":[[0,"if (tags"],[-1,"['"],[1,"."],[0,"xstreet1"],[-1,"']"],[0,") {\n    "]],"start1":8305,"start2":8305,"length1":28,"length2":25},{"diffs":[[0,"tags"],[-1,"['"],[1,"."],[0,"xstreet1"],[-1,"']"],[0,";\n  "]],"start1":8364,"start2":8364,"length1":20,"length2":17}]],"length":8399,"saved":false}
